<?php
/**
 * set the HTTP GET parameters manually if search_engine_friendly_urls is enabled
 *
 * @package initSystem
 * @copyright Copyright 2003-2005 Zen Cart Development Team
 * @copyright Portions Copyright 2003 osCommerce
 * @license http://www.zen-cart.com/license/2_0.txt GNU Public License V2.0
 * @version $Id: init_sefu.php 2753 2005-12-31 19:17:17Z wilt $
 * 记录google和yahoo的访问记录
 */

 $log_ip = $_SERVER['REMOTE_ADDR'];
 $bot_user_ip = substr($log_ip,0,strrpos($log_ip,'.')) . '.*';

$yahoo_ip_c = array('109.86.48.*','111.121.26.*','111.167.0.*','111.167.4.*','111.192.174.*','114.241.191.*','114.244.48.*','114.244.53.*','114.244.58.*','114.244.60.*',
                    '114.246.141.*','114.249.229.*','114.249.43.*','115.45.64.*','116.25.123.*','116.25.139.*','116.30.4.*','117.136.0.*','117.23.3.*','117.36.116.*',
                    '117.84.58.*','118.251.32.*','119.103.140.*','119.125.160.*','119.133.224.*','119.177.118.*','119.181.84.*','119.21.137.*','119.249.238.*','119.48.156.*',
                    '120.11.168.*','120.11.64.*','120.11.88.*','120.7.220.*','121.14.250.*','121.14.91.*','121.19.160.*','121.229.176.*','121.34.58.*','122.139.223.*',
                    '122.200.74.*','122.232.103.*','122.236.103.*','123.114.212.*','123.115.115.*','123.115.23.*','123.116.125.*','123.116.99.*','123.120.227.*',
                    '123.121.233.*','123.123.213.*','123.123.243.*','123.124.17.*','123.129.191.*','123.132.90.*','123.181.37.*','123.5.181.*','124.115.6.*','124.129.226.*',
                    '124.132.167.*','124.225.92.*','124.237.233.*','124.64.199.*','124.79.245.*','125.33.202.*','125.34.174.*','125.70.72.*','125.93.107.*','202.105.12.*',
                    '202.160.178.*','202.160.179.*','202.160.180.*','202.160.181.*','202.160.182.*','202.160.184.*','202.160.187.*','202.160.188.*','202.160.189.*',
                    '203.209.252.*','203.7.198.*','205.209.170.*','208.115.111.*','216.129.119.*','218.20.3.*','218.26.219.*','218.3.215.*','218.83.159.*','219.234.81.*',
                    '219.236.249.*','219.237.197.*','220.181.19.*','220.181.61.*','220.181.94.*','221.192.238.*','221.219.114.*','221.221.151.*','221.221.153.*',
                    '221.221.182.*','221.221.195.*','221.226.139.*','221.239.225.*','222.130.243.*','222.130.250.*','222.35.122.*','222.35.173.*','222.72.121.*','222.76.25.*',
                    '222.87.254.*','222.94.224.*','58.18.67.*','58.220.47.*','58.253.114.*','58.254.39.*','58.254.39.*','58.47.77.*','58.49.161.*','58.60.217.*','58.61.179.*',
                    '58.61.50.*','58.83.252.*','59.108.55.*','59.37.198.*','59.40.117.*','59.51.62.*','59.56.68.*','60.10.232.*','60.11.135.*','60.14.205.*','60.17.98.*',
                    '60.180.202.*','60.24.81.*','60.25.95.*','60.9.224.*','61.135.220.*','61.143.12.*','61.144.175.*','61.150.43.*','61.51.102.*','61.51.205.*','61.51.255.*',
                    '61.51.42.*','61.51.56.*','61.51.57.*','61.51.58.*','65.55.106.*','65.55.207.1*','65.55.211.*','66.235.124.*','66.249.68.*','67.195.110.*','67.195.112.*',
                    '67.195.114.*','67.195.115.*','67.195.115.*','67.195.37.*','71.10.68.*','72.30.142.*','72.30.161.*','72.30.65.*','72.30.78.*','72.30.79.*','72.30.81.*',
                    '72.30.87.*','74.6.17.*','74.6.18.*','74.6.22.*','74.6.8.*','77.131.190.*','79.224.168.*','83.171.173.*','84.202.84.*','87.212.120.*','88.112.55.*',
                    '91.121.76.*','95.34.220.*','96.2.81.*');
 $google_ip_c = array('66.249.65.*','66.249.68.*','66.249.71.*','203.208.60.*','222.73.247.*');
 foreach($yahoo_ip_c as $value){
     if($value == $bot_user_ip){
         log_bot_information('Yahoo Slurp');
     }
 }
 foreach($google_ip_c as $value){
     if($value == $bot_user_ip){
         log_bot_information('Googlebot  ');
     }
 }
 function log_bot_information($site = 'google'){
     if($_GET['main_page'] == 'page_not_found'){
         $log_text = 'log_bot_failure.txt'; //失败页面
     } else {
         $log_text = 'log_bot_success.txt';
     }
     if(!$log_handle = fopen($log_text,'ab+')){
         return;
     }
     $string = $site . ":  " . date("Y-m-d H:i:s") . "   " . $_SERVER['REQUEST_URI'] . "\r\n";

     if(fwrite($log_handle,$string) === FALSE) {
         return;
     }

     fclose($log_handle);
 }
 
 //----------------------------------- 添加从email过来的记录 ---------------------------------------//
 if($_GET['utm_source'] == 'email'){
    log_email_information();
 }
 
 function log_email_information(){
    global $log_ip;
    $log_email_text = 'log_email.txt';
    if(!$log_email_handle = fopen($log_email_text,'r')) {
        return;
    }
    fclose($log_email_handle);
    
    $log_email_json = file_get_contents($log_email_text);//echo $log_email_json;print_r(json_decode($log_email_json,true));die();
    $log_email_array = json_decode($log_email_json,true);
    
    $log_email_array[$log_ip][] = $_SERVER['REQUEST_URI'];
        
    $log_email_array[$log_ip] = array_unique($log_email_array[$log_ip]);
        
    $log_email_string = json_encode($log_email_array);

    if(!$log_email_handle = fopen($log_email_text,'wb+')) {
        return;
    }        
    if(fwrite($log_email_handle,$log_email_string) === FALSE){
        return;
    }
    
    
 }
?>